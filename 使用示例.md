# Excel批量处理工具 - 使用示例

## 快速开始指南

### 步骤1: 准备模板文件

在 `templates/` 目录下创建 `template.xlsx` 文件，格式如下：

```
A列        B列    C列    D列
品名及规格  单位   数量   金额
```

### 步骤2: 准备源数据文件

创建需要处理的Excel文件，应包含明细数据行和合计行，格式如下：

**示例源文件 (invoice_data.xlsx):**
```
A列        B列    C列      D列       E列      F列
品名及规格  单位   数量     单价      金额     备注
本子       本     296.00   6.2000    1,835.20
本子       本     282.00   8.2000    2,312.40
合计                                4,147.60
```

**注意事项:**
- 程序会从配置的起始行开始读取数据
- 遇到"合计"、"小计"、"总计"等结束标识时停止读取
- 空行会被自动跳过
- 只读取配置中指定的字段（品名及规格、单位、数量、金额）

### 步骤3: 配置数据映射

确认 `config/settings.py` 中的配置符合您的需要：

```python
# 源数据配置
SOURCE_CONFIG = {
    'start_row': 2,     # 从第2行开始读取（跳过表头）
    'start_col': 1,     # 从第1列开始
    'fields': {
        'product_name': 1,   # A列 - 品名及规格
        'unit': 2,           # B列 - 单位
        'quantity': 3,       # C列 - 数量
        'amount': 5,         # E列 - 金额 (跳过D列单价)
    },
    
    # 结束标识 - 遇到这些内容时停止读取
    'end_markers': ['合计', '合 计', '小计', '小 计', '总计', '总 计'],
    
    # 跳过空行配置
    'skip_empty_rows': True,
    
    # 必填字段 - 这些字段都为空时认为是空行
    'required_fields': ['product_name'],
}

# 模板填充配置
TARGET_CONFIG = {
    'fill_positions': {
        'product_name': 1,   # A列 - 品名及规格
        'unit': 2,           # B列 - 单位
        'quantity': 3,       # C列 - 数量
        'amount': 4,         # D列 - 金额
    },
    
    # 数据起始行
    'data_start_row': 2,
    
    # 是否在末尾添加合计行
    'add_total_row': True,
    'total_label': '合计',
    'total_label_column': 1,  # 合计标签放在第1列
    'total_amount_column': 4, # 合计金额放在第4列
}
```

### 步骤4: 运行程序

1. 启动程序：`python main.py`
2. 选择包含Excel文件的源文件夹
3. 选择输出文件夹
4. 点击"开始处理"

### 步骤5: 查看结果

处理完成后，在输出文件夹中会生成类似以下文件：
```
invoice_data_processed_20241201_143022.xlsx
```

输出文件格式：
```
A列        B列    C列      D列
品名及规格  单位   数量     金额
本子       本     296.00   1835.20
本子       本     282.00   2312.40
合计                       4147.60
```

## 支持的数据格式

### 单行数据示例
```
品名及规格  单位  数量      单价     金额       备注
本子       本    2,698.00  6.2000   16,665.60
合计                                16,665.60
```

### 多行数据示例
```
品名及规格  单位  数量     单价     金额      备注
本子       本    296.00   6.2000   1,835.20
本子       本    282.00   8.2000   2,312.40
合计                               4,147.60
```

### 空行处理
```
品名及规格  单位  数量     单价     金额      备注
本子       本    100.00   5.0000   500.00
                                   
笔        支    50.00    2.0000   100.00    (空行会被跳过)
合计                               600.00
```

## 常见使用场景

### 场景1: 发票明细处理
- **源文件**: 包含商品明细的发票Excel文件
- **模板**: 标准化的明细表模板
- **输出**: 统一格式的明细数据，自动计算合计

### 场景2: 采购单据整理
- **源文件**: 各种格式的采购明细
- **模板**: 标准采购明细模板
- **输出**: 规范格式的采购明细表

### 场景3: 销售数据汇总
- **源文件**: 销售明细数据
- **模板**: 销售报表模板
- **输出**: 标准化销售报表

## 自定义配置示例

### 示例1: 不同的结束标识

如果您的数据使用不同的结束标识：

```python
SOURCE_CONFIG = {
    'end_markers': ['总计', 'TOTAL', 'SUM', '汇总'],
    # ... 其他配置
}
```

### 示例2: 不同的列映射

如果您的数据列顺序不同：

```python
SOURCE_CONFIG = {
    'fields': {
        'product_name': 2,   # B列 - 品名及规格
        'unit': 3,           # C列 - 单位
        'quantity': 1,       # A列 - 数量
        'amount': 4,         # D列 - 金额
    }
}
```

### 示例3: 自定义合计行

如果您想自定义合计行的格式：

```python
TARGET_CONFIG = {
    'add_total_row': True,
    'total_label': '小计',
    'total_label_column': 2,  # 合计标签放在第2列
    'total_amount_column': 5, # 合计金额放在第5列
}
```

## 数据处理特性

### 自动数字格式处理
- 自动识别和转换带逗号的数字格式（如：1,835.20）
- 处理中文逗号（，）和英文逗号（,）
- 自动计算金额合计

### 智能空行跳过
- 自动跳过完全空白的行
- 可配置必填字段，只要必填字段为空就跳过该行
- 防止因格式不规范导致的处理错误

### 多种结束标识支持
- 支持多种合计行标识：合计、小计、总计等
- 支持带空格的标识：合 计、小 计等
- 可自定义结束标识列表

## 批量处理提示

1. **数据一致性**: 确保同一批次文件的数据格式一致
2. **模板验证**: 处理前先用少量文件测试模板是否正确
3. **备份数据**: 处理前建议备份原始文件
4. **检查日志**: 查看处理日志了解详细的处理情况
5. **验证结果**: 处理完成后抽查几个输出文件验证正确性

## 故障排除

### 问题: 读取不到数据
**解决**: 
1. 检查起始行配置是否正确
2. 确认字段列映射是否匹配实际文件
3. 检查是否有合计行导致提前结束

### 问题: 合计金额不正确
**解决**: 
1. 检查金额列是否配置正确
2. 确认数据中的金额格式（是否有逗号等）
3. 查看日志了解哪些行的金额无法解析

### 问题: 输出格式不符合要求
**解决**: 
1. 检查模板文件格式
2. 确认TARGET_CONFIG中的填充位置
3. 验证表头配置是否正确

## 技术支持

如果您在使用过程中遇到问题：

1. 查看程序日志输出获取详细错误信息
2. 检查配置文件设置是否匹配数据格式
3. 验证源文件和模板文件格式
4. 参考README.md文档了解更多配置选项 